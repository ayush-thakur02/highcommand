{% extends "base.html" %}

{% block title %}My Tasks - HighCommand{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">MY TASKS</h1>
</div>

<div class="grid grid-3 mb-2">
    <div class="stat-box">
        <span class="stat-number">{{ todo_count }}</span>
        <span class="stat-label">TODO</span>
    </div>
    <div class="stat-box">
        <span class="stat-number">{{ in_progress_count }}</span>
        <span class="stat-label">IN PROGRESS</span>
    </div>
    <div class="stat-box">
        <span class="stat-number">{{ tasks|selectattr('status', 'equalto', 'done')|list|length }}</span>
        <span class="stat-label">DONE</span>
    </div>
</div>

{% if tasks %}
<!-- Task Filters -->
<div class="filter-bar">
    <div class="filter-group">
        <label for="filter-status">STATUS:</label>
        <select id="filter-status" onchange="filterTasks()">
            <option value="active" selected>TODO & IN PROGRESS</option>
            <option value="todo">TODO</option>
            <option value="in-progress">IN PROGRESS</option>
            <option value="done">DONE</option>
            <option value="all">ALL</option>
        </select>
    </div>
    <div class="filter-group">
        <label for="filter-priority">PRIORITY:</label>
        <select id="filter-priority" onchange="filterTasks()">
            <option value="all">ALL</option>
            <option value="low">LOW</option>
            <option value="medium">MEDIUM</option>
            <option value="high">HIGH</option>
        </select>
    </div>
    <button class="btn btn-small" onclick="clearFilters()">CLEAR</button>
</div>

<ul class="list" id="task-list">
    {% for task in tasks %}
    <li class="list-item" data-status="{{ task.status }}" data-priority="{{ task.priority }}">
        <div style="flex: 1;">
            <div class="list-item-title">
                <span class="badge badge-{{ task.status }}">{{ task.status|upper }}</span>
                <span class="badge badge-{{ task.priority }}">{{ task.priority|upper }}</span>
                {{ task.title }}
            </div>
            <div class="list-item-meta">
                Project: {{ task.project_name }} | Due: {{ task.due_date or 'No due date' }}
                <br>Assigned to: {{ task.assignee_names }}
            </div>
        </div>
        <div class="list-item-actions">
            {% if task.status != 'done' %}
            <form method="POST" action="{{ url_for('task_mark_complete', task_id=task.id) }}" style="display: inline;">
                <button type="submit" class="btn btn-small btn-success">âœ“ DONE</button>
            </form>
            {% endif %}
            <a href="{{ url_for('task_detail', task_id=task.id) }}" class="btn btn-small">VIEW</a>
        </div>
    </li>
    {% endfor %}
</ul>
<div id="no-results" class="card" style="display: none;">
    <p>NO TASKS MATCH THE SELECTED FILTERS.</p>
</div>
{% else %}
<div class="card">
    <p>NO TASKS ASSIGNED TO YOU.</p>
</div>
{% endif %}

<script>
    // Run filter on page load to show only active tasks by default
    document.addEventListener('DOMContentLoaded', function () {
        filterTasks();
    });

    function filterTasks() {
        const statusFilter = document.getElementById('filter-status').value;
        const priorityFilter = document.getElementById('filter-priority').value;
        const tasks = document.querySelectorAll('#task-list .list-item');
        let visibleCount = 0;

        tasks.forEach(task => {
            const status = task.getAttribute('data-status');
            const priority = task.getAttribute('data-priority');

            let statusMatch = false;
            if (statusFilter === 'all') {
                statusMatch = true;
            } else if (statusFilter === 'active') {
                statusMatch = (status === 'todo' || status === 'in-progress');
            } else {
                statusMatch = status === statusFilter;
            }

            const priorityMatch = priorityFilter === 'all' || priority === priorityFilter;

            if (statusMatch && priorityMatch) {
                task.style.display = 'flex';
                visibleCount++;
            } else {
                task.style.display = 'none';
            }
        });

        document.getElementById('no-results').style.display = visibleCount === 0 ? 'block' : 'none';
    }

    function clearFilters() {
        document.getElementById('filter-status').value = 'active';
        document.getElementById('filter-priority').value = 'all';
        filterTasks();
    }
</script>
{% endblock %}