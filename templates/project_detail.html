{% extends "base.html" %}

{% block title %}{{ project.name }} - HighCommand{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">{{ project.name }}</h1>
    <div class="page-actions">
        {% if is_member %}
        <a href="{{ url_for('task_new', project_id=project.id) }}" class="btn btn-primary">NEW TASK</a>
        {% endif %}
        {% if is_owner %}
        <a href="{{ url_for('project_edit', project_id=project.id) }}" class="btn">EDIT</a>
        {% endif %}
    </div>
</div>

<div class="grid grid-3 mb-2">
    <div class="card" style="grid-column: span 2;">
        <div class="detail-row">
            <div class="detail-label">OWNER</div>
            <div class="detail-value">{{ project.owner_name }}</div>
        </div>
        <div class="detail-row">
            <div class="detail-label">STATUS</div>
            <div class="detail-value">{{ project.status|upper }}</div>
        </div>
        <div class="detail-row">
            <div class="detail-label">CREATED</div>
            <div class="detail-value">{{ project.created_at }}</div>
        </div>
        <div class="detail-row">
            <div class="detail-label">VM IP</div>
            <div class="detail-value">{{ project.vm_ip or 'Not set' }}</div>
        </div>
        <div class="detail-row" style="border-bottom: none;">
            <div class="detail-label">DESCRIPTION</div>
            <div class="detail-value">{{ project.description or 'No description' }}</div>
        </div>
    </div>

    {% if is_member %}
    <!-- Team Members Link Card -->
    <div class="card" style="display: flex; flex-direction: column; justify-content: center; align-items: center;">
        <div class="stat-number">{{ members|length }}</div>
        <div class="stat-label" style="margin-bottom: 12px;">TEAM MEMBERS</div>
        <a href="{{ url_for('project_members', project_id=project.id) }}" class="btn">VIEW TEAM</a>
    </div>
    {% endif %}
</div>

{% if not is_member %}
<div class="card mb-2">
    <p><strong>YOU ARE NOT A MEMBER OF THIS PROJECT.</strong></p>
    <form method="POST" action="{{ url_for('project_join_request', project_id=project.id) }}">
        <button type="submit" class="btn btn-primary mt-1">REQUEST TO JOIN</button>
    </form>
</div>
{% endif %}

{% if is_member %}

<div class="grid grid-4 mb-2">
    <div class="stat-box">
        <span class="stat-number">{{ task_stats.total }}</span>
        <span class="stat-label">TOTAL TASKS</span>
    </div>
    <div class="stat-box">
        <span class="stat-number">{{ task_stats.todo }}</span>
        <span class="stat-label">TODO</span>
    </div>
    <div class="stat-box">
        <span class="stat-number">{{ task_stats.in_progress }}</span>
        <span class="stat-label">IN PROGRESS</span>
    </div>
    <div class="stat-box">
        <span class="stat-number">{{ task_stats.done }}</span>
        <span class="stat-label">DONE</span>
    </div>
</div>

<div class="section">
    <div class="section-header">TASKS</div>

    {% if tasks %}
    <!-- Task Filters -->
    <div class="filter-bar">
        <div class="filter-group">
            <label for="filter-status">STATUS:</label>
            <select id="filter-status" onchange="filterTasks()">
                <option value="active" selected>TODO & IN PROGRESS</option>
                <option value="todo">TODO</option>
                <option value="in-progress">IN PROGRESS</option>
                <option value="done">DONE</option>
                <option value="all">ALL</option>
            </select>
        </div>
        <div class="filter-group">
            <label for="filter-priority">PRIORITY:</label>
            <select id="filter-priority" onchange="filterTasks()">
                <option value="all">ALL</option>
                <option value="low">LOW</option>
                <option value="medium">MEDIUM</option>
                <option value="high">HIGH</option>
            </select>
        </div>
        <button class="btn btn-small" onclick="clearFilters()">CLEAR</button>
    </div>

    <ul class="list" id="task-list">
        {% for task in tasks %}
        <li class="list-item" data-status="{{ task.status }}" data-priority="{{ task.priority }}">
            <div style="flex: 1;">
                <div class="list-item-title">
                    {{ task.title }}
                    <span class="badge badge-{{ task.status }}">{{ task.status|upper }}</span>
                    <span class="badge badge-{{ task.priority }}">{{ task.priority|upper }}</span>
                </div>
                <div class="list-item-meta">
                    Assigned to: {{ task.assignee_names }} |
                    Due: {{ task.due_date or 'No due date' }} |
                    Creator: {{ task.creator_name }}
                </div>
            </div>
            <div class="list-item-actions">
                <a href="{{ url_for('task_detail', task_id=task.id) }}" class="btn btn-small">VIEW</a>
                <a href="{{ url_for('task_edit', task_id=task.id) }}" class="btn btn-small">EDIT</a>
            </div>
        </li>
        {% endfor %}
    </ul>
    <div id="no-results" class="card" style="display: none;">
        <p>NO TASKS MATCH THE SELECTED FILTERS.</p>
    </div>
    {% else %}
    <div class="card">
        <p>NO TASKS YET. <a href="{{ url_for('task_new', project_id=project.id) }}">CREATE THE FIRST TASK</a></p>
    </div>
    {% endif %}
</div>

<div class="detail-actions">
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <a href="{{ url_for('project_export', project_id=project.id) }}" class="btn">EXPORT TASKS (CSV)</a>

        {% if is_owner %}
        <form method="POST" action="{{ url_for('project_delete', project_id=project.id) }}"
            onsubmit="return confirm('DELETE THIS PROJECT AND ALL ITS TASKS? THIS CANNOT BE UNDONE.');">
            <button type="submit" class="btn btn-danger">DELETE PROJECT</button>
        </form>
        {% endif %}
    </div>
</div>
{% endif %}

<script>
    // Run filter on page load to show only active tasks by default
    document.addEventListener('DOMContentLoaded', function () {
        filterTasks();
    });

    function toggleDropdown(id) {
        const content = document.getElementById(id);
        const header = content.previousElementSibling;
        if (content.style.display === 'none') {
            content.style.display = 'block';
            header.querySelector('span').textContent = header.querySelector('span').textContent.replace('▶', '▼');
        } else {
            content.style.display = 'none';
            header.querySelector('span').textContent = header.querySelector('span').textContent.replace('▼', '▶');
        }
    }

    function filterTasks() {
        const statusFilter = document.getElementById('filter-status').value;
        const priorityFilter = document.getElementById('filter-priority').value;
        const tasks = document.querySelectorAll('#task-list .list-item');
        let visibleCount = 0;

        tasks.forEach(task => {
            const status = task.getAttribute('data-status');
            const priority = task.getAttribute('data-priority');

            let statusMatch = false;
            if (statusFilter === 'all') {
                statusMatch = true;
            } else if (statusFilter === 'active') {
                statusMatch = (status === 'todo' || status === 'in-progress');
            } else {
                statusMatch = status === statusFilter;
            }

            const priorityMatch = priorityFilter === 'all' || priority === priorityFilter;

            if (statusMatch && priorityMatch) {
                task.style.display = 'flex';
                visibleCount++;
            } else {
                task.style.display = 'none';
            }
        });

        document.getElementById('no-results').style.display = visibleCount === 0 ? 'block' : 'none';
    }

    function clearFilters() {
        document.getElementById('filter-status').value = 'active';
        document.getElementById('filter-priority').value = 'all';
        filterTasks();
    }
</script>
{% endblock %}